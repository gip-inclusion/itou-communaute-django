{% extends "layouts/base.html" %}
{% load static %}
{% load i18n %}
{% load forum_permission_tags %}
{% load mptt_tags %}
{% load forum_tags %}

{% block title %}Accueil{{ block.super }}{% endblock %}
{% block meta_description %}Entraide, information et apprentissage pour les professionnels de l'Insertion par l'Activité Economique{% endblock meta_description %}"

{% block body_class %}p-homepage{{ block.super }}{% endblock %}

{% block content %}

    {% if user.is_authenticated %}
        <section class="s-page-menu-01 s-page-menu-01--communaute">
            <div class="s-page-menu-01__container container">
                <div class="s-page-menu-01__row row align-items-center">
                    <div class="s-page-menu-01__col s-page-menu-01__col--title col-12">
                        <h1 class="h1-hero lh-sm font-weight-bold m-0">Entraide, actus et apprentissage pour les professionnels de l'IAE</h1>
                    </div>
                </div>
                <div class="s-page-menu-01__row row">
                    <div class="s-page-menu-01__col s-page-menu-01__col--title col-12 col-lg-8 mt-3 mt-lg-5">
                        {% include "partials/ask_a_question.html" %}
                    </div>
                    <div class="s-page-menu-01__col col-12 mt-3 mt-lg-5">
                        {% include "partials/banner.html" %}
                    </div>
                </div>
            </div>
        </section>
    {% else %}
        <section class="s-page-menu-01 s-page-menu-01--communaute">
            <div class="s-page-menu-01__container container">
                <div class="s-page-menu-01__row row align-items-center">
                    <div class="s-page-menu-01__col s-page-menu-01__col--title col-12">
                        <h1 class="h1-hero lh-sm font-weight-bold m-0">Entraide, actus et apprentissage<br>pour les professionnels de l'IAE</h1>
                    </div>
                </div>
                <div class="s-page-menu-01__row row align-items-center">
                    <div class="s-page-menu-01__col s-page-menu-01__col--title col-12 col-lg-8 mt-3 mt-lg-5">
                        <h2 class="h1 mb-3 mb-lg-5">Améliorez votre pratique professionnelle :</h2>
                        <ul class="lead list-unstyled mb-md-5">
                            <li class="d-flex mb-2">
                                <i class="text-success ri-checkbox-circle-fill ri-xxl"></i>
                                <span class="ml-2">Posez vos questions et répondez aux autres professionnels</span>
                            </li>
                            <li class="d-flex mb-2">
                                <i class="text-success ri-checkbox-circle-fill ri-xxl"></i>
                                <span class="ml-2">Retrouvez les dernières actus et infos de l'inclusion</span>
                            </li>
                            <li class="d-flex mb-2">
                                <i class="text-success ri-loader-2-line ri-xxl"></i>
                                <span class="ml-2">Progressez grâce à des ressources exclusives</span>
                            </li>
                        </ul>
                        {% include "partials/ask_a_question.html" %}
                    </div>
                    <div class="s-page-menu-01__col col-12 d-none d-lg-inline-flex col-md-4">
                        <div>
                            <img src="{% static 'images/hp-illustration-01.svg' %}" class="img-fluid w-lg-75" loading="lazy" alt="">
                        </div>
                    </div>
                </div>
                <div class="s-page-menu-01__row row">
                    <div class="s-page-menu-01__col col-12 mt-3 mt-lg-5">
                        {% include "partials/banner.html" %}
                    </div>
                </div>
            </div>
        </section>
    {% endif %}

    <div id="community"></div>

    <section class="s-tabs-01 mt-0">
        <div class="s-tabs-01__container container">
            <div class="s-tabs-01__row row">
                <div class="s-tabs-01__col col-12">
                    <ul class="s-tabs-01__nav nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link{% if forums_tab %} active{% endif %}" id="forums_tab"
                                data-toggle="tab"
                                href="#forums"
                                role="tab"
                                aria-controls="forums"
                                aria-selected="{% if forums_tab %}true{% else %}false{% endif %}">
                                Thématiques
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link{% if pending_topics_tab %} active{% endif %}" id="pending-topics-tab"
                                data-toggle="tab"
                                href="#pending-topics"
                                role="tab"
                                aria-controls="pending-topics"
                                aria-selected="{% if pending_topics_tab %}true{% else %}false{% endif %}"
                                data-matomo-category="engagement"
                                data-matomo-action="view"
                                data-matomo-option="pending_topics">
                                Questions en attente
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a id="newsfeed-topics-tab"
                                data-toggle="tab"
                                href="#newsfeed-topics"
                                role="tab"
                                aria-controls="newsfeed-topics"
                                aria-selected="false"
                                hx-target="#newsfeedtopicsarea"
                                hx-swap="outerHTML"
                                hx-get="{% url 'forum_conversation_extension:newsfeed_topics_list' %}"
                                hx-trigger="load"
                                class="nav-link matomo-event"
                                data-matomo-category="engagement"
                                data-matomo-action="loadmore"
                                data-matomo-option="newsfeed_topic">
                                Actualités
                            </a>
                        </li>
                        <li class="nav-item-dropdown dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" id="sTabs01DropdownMoreLink" data-toggle="dropdown" aria-expanded="false"><i class="ri-more-line" aria-hidden="true"></i></a>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="sTabs01DropdownMoreLink"></div>
                        </li>
                    </ul>
                    <div class="tab-content topiclist">
                        <div class="tab-pane fade{% if forums_tab %} show active{% endif %}" id="forums"
                            role="tabpanel"
                            aria-labelledby="forums_tab">
                            {% forum_list forums %}
                        </div>
                        <div class="tab-pane fade{% if pending_topics_tab %} show active{% endif %}" id="pending-topics"
                            role="tabpanel"
                            aria-labelledby="pending-topics-tab">
                            {% with topics=topics topic_list_title="Questions en attente" %}
                                {% include "forum_conversation/topic_list.html" %}
                            {% endwith %}
                        </div>
                        <div class="tab-pane fade" id="certified-topics"
                            role="tabpanel"
                            aria-labelledby="certified-topics-tab">
                            <div id="certifiedtopicsarea">
                                chargement en cours...
                            </div>
                        </div>
                        <div class="tab-pane fade" id="newsfeed-topics"
                            role="tabpanel"
                            aria-labelledby="newsfeed-topics-tab">
                            <div id="newsfeedtopicsarea">
                                chargement en cours...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    {% if not user.is_authenticated %}
        <section class="s-section">
            <div class="s-section__container container">
                <div class="s-section__row row mb-1 mb-md-3">
                    <div class="s-section__col col-12 col-lg-auto">
                        <a href="{% url 'inclusion_connect:authorize' %}" class="btn btn-block btn-ico btn-outline-primary justify-content-center">
                            <i class="ri-login-box-line ri-lg" aria-hidden="true"></i>
                            <span>
                                Je me connecte pour accéder à toutes mes thématiques
                            </span>
                        </a>
                    </div>
                </div>
            </div>
        </section>
    {% endif %}

{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script async src="https://tally.so/widgets/embed.js"></script>
    <script defer>
        // Any given Tally popup will not be shown more than once every `minDaysBetweenDisplays` days.
        const minDaysBetweenDisplays = 14;
        const delayBeforeShowingPopupInSeconds = 45;
        const formId = 'mVGEr6';
        const key = 'statsTallyPopupLastShown-' + formId;
        const todaysDate = new Date();

        function supportsLocalStorage() {
            try {
                return 'localStorage' in window && window['localStorage'] !== null;
            } catch (e) {
                return false;
            }
        };

        function stopShowingPopupForAWhile() {
            localStorage.setItem(key, JSON.stringify(todaysDate));
        }

        function displayTallyPopup() {
            window.Tally.openPopup(formId, {
                emoji: {
                    text: "👋",
                    animation: "wave"
                },
                onClose: () => {
                    stopShowingPopupForAWhile();
                },
                onSubmit: () => {
                    stopShowingPopupForAWhile();
                }
            });
        };

        function shouldDisplayTallyPopup() {
            if (!supportsLocalStorage()) {
                return true;
            }
            infoKey = localStorage.getItem(key);
            if (infoKey) {
                const lastShown = Date.parse(JSON.parse(localStorage.getItem(key)));
                const milliSecondsElapsed = todaysDate - lastShown;
                const daysElapsed = milliSecondsElapsed / (1000 * 3600 * 24);
                if (daysElapsed <= minDaysBetweenDisplays) {
                    return false;
                };
            };
            return true;
        };

        if (shouldDisplayTallyPopup()) {
            setTimeout(displayTallyPopup, delayBeforeShowingPopupInSeconds * 1000);
        };
    </script>
{% endblock %}
